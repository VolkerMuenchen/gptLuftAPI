<!DOCTYPE html>
<html lang='de'>
<head>
  <meta charset='utf-8'/>
  <meta name='viewport' content='width=device-width, initial-scale=1'/>
  <title>PM2.5 Karte</title>
  <link rel='stylesheet' href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'/>
  <script src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:0}
    h2{margin:12px 16px}
    #map{height:72vh;margin:0 16px;border-radius:8px}
    .legend{position:absolute;bottom:16px;left:26px;background:#fff;padding:8px 10px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.15);line-height:1.4}
    .legend .dot{font-size:18px;vertical-align:middle;margin-right:6px}
  </style>
</head>
<body>
  <h2>PM2.5 Sensorwerte mit Mini-Charts (Klick auf Marker)</h2>
  <div id='map'></div>

  <div class='legend'><b>Legende</b><br>
    <span class='dot' style='color:green'>●</span> ≤ 10&nbsp;&nbsp;
    <span class='dot' style='color:orange'>●</span> 11–20&nbsp;&nbsp;
    <span class='dot' style='color:red'>●</span> > 20
  </div>

  <script>
    var map = L.map('map').setView([48.5216, 9.0576], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

    var sensors = {};
sensors['81607'] = {lat:48.122000, lon:11.576000, color:'green', labels:['22:45','22:50','22:55','22:58','23:10','23:12','23:14','23:17','23:22','23:24','23:27','23:29','23:34','23:37','23:40','00:07','00:10','00:32','00:35','01:02','01:05','01:32','01:34','02:02','02:05','02:32','02:35','07:20','07:22','07:49','07:52','08:37','08:39','10:05','10:07','10:35','10:38','11:20','11:22','11:49','11:52','11:54','12:21','12:23','12:25','12:53','12:55','14:13','14:15','14:30','14:33','15:00','15:02','15:30','15:32','15:34','16:00','16:02','16:30','16:32','17:00','17:02','17:04'], values:[3.85,3.47,3.85,3.47,3.85,3.47,2.97,2.83,3.15,3.38,3.30,2.80,3.03,2.83,2.92,3.10,3.17,2.60,3.00,2.97,3.25,3.75,3.78,2.97,2.97,1.67,1.85,2.38,2.17,2.35,2.72,2.17,2.38,2.17,2.22,1.92,1.80,2.50,1.73,1.63,1.70,2.03,2.08,1.90,1.75,1.65,1.80,1.75,2.03,2.22,2.47,2.55,2.53,2.50,2.13,2.53,2.63,2.67,2.90,2.50,3.03,3.20,3.50]};
sensors['489'] = {lat:48.160000, lon:11.574000, color:'orange', labels:['10:05','10:08','10:35','10:38','11:21','11:23','11:51','11:53','12:21','12:23','12:51','12:53','14:13','14:15','14:30','14:33','15:01','15:04','15:31','15:34','16:01','16:04','16:31','16:34','17:01','17:04'], values:[14.40,14.53,11.90,11.23,17.20,16.97,11.60,12.13,12.27,11.60,10.20,9.97,11.90,12.30,12.77,12.43,14.47,13.30,12.07,12.87,13.80,13.37,14.33,15.40,15.90,15.53]};
sensors['30525'] = {lat:48.114908, lon:11.581892, color:'orange', labels:['10:04','10:06','10:34','10:36','11:21','11:24','11:51','11:54','12:21','12:24','12:51','12:53','14:13','14:15','14:30','14:33','15:00','15:03','15:30','15:33','16:00','16:02','16:30','16:32','17:00','17:02','17:04'], values:[7.97,8.23,7.43,7.40,9.07,9.40,7.83,8.60,7.43,7.50,5.97,6.50,7.37,8.07,8.60,9.40,10.20,10.03,9.47,9.43,10.33,10.60,12.03,11.87,12.50,11.33,12.27]};
(function(){
    var d = sensors['81607'];
    var m = L.circleMarker([d.lat, d.lon], {radius: 10, color: d.color}).addTo(map);

    m.on('click', function(){
        if (d.values.length >= 3) {
            var cid = 'chart_81607';
            var content =
              "<b>Sensor 81607</b><br>Messpunkte: " + d.values.length +
              "<div style='width:320px;margin-top:6px'>" +
              "<canvas id='" + cid + "' width='320' height='160'></canvas>" +
              "</div>";
            this.bindPopup(content).openPopup();

            setTimeout(function(){
                var canvas = document.getElementById(cid);
                if (!canvas) return;
                var ctx = canvas.getContext('2d');

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: d.labels,
                        datasets: [{
                            label: 'PM2.5',
                            data: d.values,
                            borderColor: 'blue',
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }, 80);

        } else {
            this.bindPopup("<b>Sensor 81607</b><br>Nicht genug Daten (mind. 3 Punkte).").openPopup();
        }
    });

})();
(function(){
    var d = sensors['489'];
    var m = L.circleMarker([d.lat, d.lon], {radius: 10, color: d.color}).addTo(map);

    m.on('click', function(){
        if (d.values.length >= 3) {
            var cid = 'chart_489';
            var content =
              "<b>Sensor 489</b><br>Messpunkte: " + d.values.length +
              "<div style='width:320px;margin-top:6px'>" +
              "<canvas id='" + cid + "' width='320' height='160'></canvas>" +
              "</div>";
            this.bindPopup(content).openPopup();

            setTimeout(function(){
                var canvas = document.getElementById(cid);
                if (!canvas) return;
                var ctx = canvas.getContext('2d');

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: d.labels,
                        datasets: [{
                            label: 'PM2.5',
                            data: d.values,
                            borderColor: 'blue',
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }, 80);

        } else {
            this.bindPopup("<b>Sensor 489</b><br>Nicht genug Daten (mind. 3 Punkte).").openPopup();
        }
    });

})();
(function(){
    var d = sensors['30525'];
    var m = L.circleMarker([d.lat, d.lon], {radius: 10, color: d.color}).addTo(map);

    m.on('click', function(){
        if (d.values.length >= 3) {
            var cid = 'chart_30525';
            var content =
              "<b>Sensor 30525</b><br>Messpunkte: " + d.values.length +
              "<div style='width:320px;margin-top:6px'>" +
              "<canvas id='" + cid + "' width='320' height='160'></canvas>" +
              "</div>";
            this.bindPopup(content).openPopup();

            setTimeout(function(){
                var canvas = document.getElementById(cid);
                if (!canvas) return;
                var ctx = canvas.getContext('2d');

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: d.labels,
                        datasets: [{
                            label: 'PM2.5',
                            data: d.values,
                            borderColor: 'blue',
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }, 80);

        } else {
            this.bindPopup("<b>Sensor 30525</b><br>Nicht genug Daten (mind. 3 Punkte).").openPopup();
        }
    });

})();
  </script>
</body>
</html>
